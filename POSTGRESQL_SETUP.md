# PostgreSQL Cloud Database Setup

This guide covers connecting your Render deployment to a cloud PostgreSQL database using username and password authentication.

## üìã Quick Overview

Your Finance Tracker V2 on Render will connect to your cloud PostgreSQL database using these credentials:
- **Host**: Your database server URL
- **Port**: Usually 5432
- **Username**: Database user
- **Password**: Database password
- **Database**: Database name

## üöÄ Option 1: Render PostgreSQL (Recommended)

### Why Render PostgreSQL?
- Same infrastructure as your web service
- Free tier available
- Automatic backups
- Easy setup (same dashboard)
- Low latency

### Step-by-Step Setup

#### 1. Create PostgreSQL Database on Render

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **New +** ‚Üí **PostgreSQL**
3. Configure:
   ```
   Name: finance-tracker-db
   Database: finance_tracker
   User: finance_user
   Region: Oregon (same as web service)
   Plan: Free or Starter ($7/month)
   ```
4. Click **Create Database**
5. Wait ~2 minutes for provisioning

#### 2. Get Connection Details

After database is created:
1. Click on your database
2. Go to **Info** tab
3. Copy these values:
   ```
   Internal Database URL (or note these individually):
   - Hostname: <postgres-xxx>.oregon-postgres.render.com
   - Port: 5432
   - Database: finance_tracker
   - Username: finance_user
   - Password: <auto-generated-password>
   ```

#### 3. Configure Web Service

1. Go back to Dashboard ‚Üí Your web service
2. Click **Environment**
3. Add/Update these variables:

   ```
   DATABASE_PROFILE = postgresql
   POSTGRES_HOST = <hostname from step 2>
   POSTGRES_PORT = 5432
   POSTGRES_USER = finance_user
   POSTGRES_PASSWORD = <password from step 2>
   POSTGRES_DATABASE = finance_tracker
   ```

4. Click **Save Changes**
5. Your service will automatically redeploy

#### 4. Verify Connection

Check logs for:
```
Running Migrations...
Alembic upgrade head
‚úÖ Build completed successfully!
```

Test the API:
```bash
curl https://finance-tracker-v2.onrender.com/health
```

### Connection String Method (Alternative)

Instead of individual variables, you can use a single connection string:

1. In Render PostgreSQL ‚Üí **Info** ‚Üí Copy **Internal Database URL**
2. In your web service ‚Üí **Environment**, add:
   ```
   DATABASE_PROFILE = postgresql
   DATABASE_URL = <paste internal database URL>
   ```

3. Update `app/config.py` to read `DATABASE_URL` (if not already):
   ```python
   database_url: str = os.environ.get("DATABASE_URL", "")
   ```

---

## üåê Option 2: AWS RDS PostgreSQL

### Setup AWS RDS

1. **Create RDS Instance**
   - Go to AWS Console ‚Üí RDS ‚Üí Create database
   - Engine: PostgreSQL 15
   - Template: Free tier (if eligible)
   - DB instance identifier: `finance-tracker-db`
   - Master username: `postgres` or `admin`
   - Master password: Create strong password
   - DB instance class: db.t3.micro (free tier)
   - Storage: 20 GB gp2
   - Public access: **Yes** (for Render to connect)

2. **Configure Security Group**
   - EC2 ‚Üí Security Groups ‚Üí Your RDS security group
   - Add Inbound Rule:
     ```
     Type: PostgreSQL
     Port: 5432
     Source: 0.0.0.0/0 (or Render IP ranges)
     ```

3. **Get Connection Details**
   - Go to RDS ‚Üí Databases ‚Üí Your instance
   - Copy **Endpoint**: `finance-tracker-db.xxx.us-east-1.rds.amazonaws.com`
   - Port: 5432
   - Username: Your master username
   - Password: Your master password
   - Database: `postgres` (default) or create custom

4. **Create Application Database** (Optional)
   ```bash
   # Connect using psql
   psql -h <endpoint> -U postgres -d postgres

   # Create database
   CREATE DATABASE finance_tracker;

   # Create user
   CREATE USER finance_user WITH PASSWORD 'your-secure-password';
   GRANT ALL PRIVILEGES ON DATABASE finance_tracker TO finance_user;
   ```

5. **Configure Render**
   In your web service ‚Üí Environment:
   ```
   DATABASE_PROFILE = postgresql
   POSTGRES_HOST = finance-tracker-db.xxx.us-east-1.rds.amazonaws.com
   POSTGRES_PORT = 5432
   POSTGRES_USER = finance_user
   POSTGRES_PASSWORD = your-secure-password
   POSTGRES_DATABASE = finance_tracker
   ```

---

## üî∑ Option 3: Azure Database for PostgreSQL

### Setup Azure PostgreSQL

1. **Create PostgreSQL Server**
   - Azure Portal ‚Üí Create resource ‚Üí Azure Database for PostgreSQL
   - Deployment option: Flexible server
   - Server name: `finance-tracker-db`
   - Region: Choose closest to Oregon
   - PostgreSQL version: 15
   - Compute + storage: Burstable, B1ms (cheapest)
   - Admin username: `dbadmin`
   - Password: Create strong password

2. **Configure Networking**
   - Networking tab ‚Üí Firewall rules
   - Add rule: `AllowRender`
     ```
     Start IP: 0.0.0.0
     End IP: 255.255.255.255
     ```
   - Or add specific Render IP ranges

3. **Get Connection Details**
   - Server name: `finance-tracker-db.postgres.database.azure.com`
   - Port: 5432
   - Username: `dbadmin`
   - Password: Your password
   - Database: `postgres` (default)

4. **Create Application Database**
   ```sql
   CREATE DATABASE finance_tracker;
   GRANT ALL PRIVILEGES ON DATABASE finance_tracker TO dbadmin;
   ```

5. **Configure Render**
   ```
   DATABASE_PROFILE = postgresql
   POSTGRES_HOST = finance-tracker-db.postgres.database.azure.com
   POSTGRES_PORT = 5432
   POSTGRES_USER = dbadmin
   POSTGRES_PASSWORD = your-password
   POSTGRES_DATABASE = finance_tracker
   ```

---

## üêò Option 4: ElephantSQL (Managed PostgreSQL)

### Setup ElephantSQL

1. **Create Account**
   - Go to [ElephantSQL.com](https://www.elephantsql.com/)
   - Sign up (free tier available)

2. **Create Instance**
   - Click **Create New Instance**
   - Name: `finance-tracker`
   - Plan: Tiny Turtle (Free)
   - Region: US-East-1 or closest
   - Click **Review** ‚Üí **Create instance**

3. **Get Connection Details**
   - Click on your instance
   - Copy from **Details** tab:
     ```
     Server: <something>.db.elephantsql.com
     User & Default database: <your-username>
     Password: <auto-generated>
     ```

4. **Configure Render**
   ```
   DATABASE_PROFILE = postgresql
   POSTGRES_HOST = <server from step 3>
   POSTGRES_PORT = 5432
   POSTGRES_USER = <user from step 3>
   POSTGRES_PASSWORD = <password from step 3>
   POSTGRES_DATABASE = <database from step 3>
   ```

---

## üîß Configure Render Web Service

### Method 1: Using Render Dashboard (Recommended)

1. **Go to your web service**
   - Dashboard ‚Üí Services ‚Üí finance-tracker-v2

2. **Add Environment Variables**
   - Click **Environment** tab
   - Click **Add Environment Variable**
   - Add each variable:

   | Key | Value | Example |
   |-----|-------|---------|
   | `DATABASE_PROFILE` | `postgresql` | postgresql |
   | `POSTGRES_HOST` | Your DB host | db.example.com |
   | `POSTGRES_PORT` | `5432` | 5432 |
   | `POSTGRES_USER` | Your username | finance_user |
   | `POSTGRES_PASSWORD` | Your password | secretpass123 |
   | `POSTGRES_DATABASE` | Database name | finance_tracker |

3. **Save and Deploy**
   - Click **Save Changes**
   - Service automatically redeploys

### Method 2: Using render.yaml

Already configured! Just set the values in Render dashboard after deployment.

The `render.yaml` file has placeholders with `sync: false`, meaning you'll set them manually in the dashboard for security.

---

## ‚úÖ Verify Connection

### 1. Check Deployment Logs

In Render ‚Üí Your service ‚Üí Logs, look for:
```
üöÄ Starting Render build process...
üì¶ Installing Python dependencies...
üóÑÔ∏è  Running database migrations...
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade -> 5b5685173ba4
‚úÖ Build completed successfully!
```

### 2. Test Health Endpoint

```bash
curl https://finance-tracker-v2.onrender.com/health
```

Should return:
```json
{
  "status": "healthy",
  "timestamp": "2025-12-14T...",
  "service": "Finance Tracker V2",
  "version": "2.0.0"
}
```

### 3. Test Database Connection

```bash
# Register a user
curl -X POST "https://finance-tracker-v2.onrender.com/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass123"}'

# Should return user object
```

### 4. Verify in Database

Connect to your PostgreSQL database:
```bash
psql -h <your-host> -U <your-user> -d <your-database>

# Check tables
\dt

# Should see: users, parties, accounts, ledger_transactions, entries, etc.

# Check data
SELECT * FROM users;
```

---

## üîí Security Best Practices

### 1. Use Strong Passwords
```bash
# Generate secure password
openssl rand -base64 32
```

### 2. Limit IP Access
Instead of `0.0.0.0/0`, use specific Render IP ranges (if provider supports)

### 3. Use SSL/TLS
Most cloud providers enable SSL by default. Verify in connection string:
```
postgresql://user:pass@host:5432/db?sslmode=require
```

### 4. Rotate Credentials Regularly
- Change database password every 90 days
- Update in Render environment variables

### 5. Use Read-Only Replicas (Production)
For better performance, create read replicas for reporting queries.

---

## üêõ Troubleshooting

### Connection Refused

**Error**: `could not connect to server: Connection refused`

**Solutions**:
1. Check firewall rules allow Render IPs
2. Verify host/port are correct
3. Ensure database is running
4. Check if public access is enabled

### Authentication Failed

**Error**: `FATAL: password authentication failed`

**Solutions**:
1. Double-check username and password
2. Ensure no extra spaces in credentials
3. Verify user has access to database
4. Check if user exists: `SELECT * FROM pg_user;`

### SSL Required

**Error**: `SSL connection required`

**Solutions**:
Add to environment variables:
```
POSTGRES_SSLMODE = require
```

Update `app/config.py`:
```python
database_url = f"postgresql://{user}:{password}@{host}:{port}/{database}?sslmode=require"
```

### Timeout Issues

**Error**: `timeout expired`

**Solutions**:
1. Check database region (closer to Render = better)
2. Verify network connectivity
3. Increase connection timeout in code
4. Check database performance/load

### Migration Failures

**Error**: `alembic upgrade head` fails

**Solutions**:
1. Verify database is empty (first deploy)
2. Check alembic revision history: `alembic current`
3. Manually run migrations: `alembic upgrade head`
4. Check database permissions

---

## üìä Database Comparison

| Provider | Free Tier | Storage | Connections | Best For |
|----------|-----------|---------|-------------|----------|
| **Render** | ‚úÖ Yes | 1 GB | 97 | Same platform, easy setup |
| **AWS RDS** | ‚úÖ 12mo | 20 GB | Varies | Enterprise, scalability |
| **Azure** | ‚ùå No | Custom | Custom | Microsoft ecosystem |
| **ElephantSQL** | ‚úÖ Yes | 20 MB | 5 | Testing, demos |
| **Supabase** | ‚úÖ Yes | 500 MB | 500 | Modern features |
| **Neon** | ‚úÖ Yes | 3 GB | Unlimited | Serverless, branching |

---

## üí° Pro Tips

1. **Start with Render PostgreSQL** - Easiest setup, same platform
2. **Use Internal URLs** - Faster, more secure (if provider offers)
3. **Enable Connection Pooling** - Better performance under load
4. **Set up Backups** - Most providers offer automatic backups
5. **Monitor Performance** - Use provider's monitoring tools
6. **Use Environment-specific DBs** - Separate dev/staging/prod databases

---

## üìû Need Help?

- **Render Support**: [render.com/support](https://render.com/support)
- **PostgreSQL Docs**: [postgresql.org/docs](https://www.postgresql.org/docs/)
- **GitHub Issues**: Open an issue in your repository

---

**Next Steps**: Return to [DEPLOYMENT.md](DEPLOYMENT.md) to complete your deployment!
